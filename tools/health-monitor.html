<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ActionFlows — Living Architecture</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{
  --bg-healthy:#0a0a1a;--bg-degraded:#1a150a;--bg-critical:#1a0a0a;
  --aurora-healthy:rgba(100,140,255,0.06);--aurora-degraded:rgba(255,180,60,0.06);--aurora-critical:rgba(255,60,60,0.08);
  --glow-healthy:#667eea;--glow-degraded:#f59e0b;--glow-critical:#ef4444;
  --text:#d0d0f0;--text-dim:#8080b0;--text-bright:#f0f0ff;
  --panel-bg:rgba(15,15,35,0.92);--panel-border:rgba(100,100,200,0.15);
  --star-size:72px;--gate-size:18px;
}
html,body{width:100%;height:100%;overflow:hidden;font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:var(--bg-healthy);color:var(--text);font-size:12px;transition:background 2s ease}
body.degraded{background:var(--bg-degraded)}
body.critical{background:var(--bg-critical)}

/* ─── Top Bar ─── */
#topbar{position:fixed;top:0;left:0;right:0;height:32px;background:rgba(10,10,30,0.85);backdrop-filter:blur(8px);border-bottom:1px solid var(--panel-border);display:flex;align-items:center;padding:0 12px;gap:16px;z-index:100;font-size:11px}
#topbar .logo{font-weight:700;font-size:13px;color:var(--text-bright);letter-spacing:0.5px}
#topbar .sep{width:1px;height:16px;background:var(--panel-border)}
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:4px;flex-shrink:0}
.status-dot.ok{background:#10b981;box-shadow:0 0 6px rgba(16,185,129,0.6)}
.status-dot.warn{background:#f59e0b;box-shadow:0 0 6px rgba(245,158,11,0.6)}
.status-dot.err{background:#ef4444;box-shadow:0 0 6px rgba(239,68,68,0.6)}
.status-dot.off{background:#555;box-shadow:none}
#topbar .score-badge{font-weight:700;font-size:14px;min-width:32px;text-align:center}
#topbar .meta{color:var(--text-dim);font-size:10px}
#topbar .right{margin-left:auto;display:flex;align-items:center;gap:10px}
#topbar kbd{background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.12);border-radius:3px;padding:0 4px;font-size:10px;color:var(--text-dim);font-family:inherit}

/* ─── Bottom Ticker ─── */
#bottombar{position:fixed;bottom:0;left:0;right:0;height:24px;background:rgba(10,10,30,0.85);backdrop-filter:blur(8px);border-top:1px solid var(--panel-border);display:flex;align-items:center;padding:0 12px;gap:12px;z-index:100;font-size:10px;color:var(--text-dim);overflow:hidden}
#ticker{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* ─── Canvas + SVG Viewport ─── */
#cosmos{position:fixed;top:32px;left:0;right:0;bottom:24px}
#cosmos canvas{position:absolute;top:0;left:0;width:100%;height:100%}
#cosmos svg{position:absolute;top:0;left:0;width:100%;height:100%}

/* ─── Aurora background ─── */
#aurora{position:fixed;top:32px;left:0;right:0;bottom:24px;pointer-events:none;z-index:0;transition:background 2s ease}
#aurora.healthy{background:radial-gradient(ellipse 80% 60% at 50% 40%,var(--aurora-healthy),transparent)}
#aurora.degraded{background:radial-gradient(ellipse 80% 60% at 50% 40%,var(--aurora-degraded),transparent)}
#aurora.critical{background:radial-gradient(ellipse 80% 60% at 50% 40%,var(--aurora-critical),transparent);animation:pulse-warn 3s ease-in-out infinite}
@keyframes pulse-warn{0%,100%{opacity:1}50%{opacity:0.6}}

/* ─── Star Nodes ─── */
.star{position:absolute;width:var(--star-size);height:var(--star-size);transform:translate(-50%,-50%);cursor:pointer;z-index:10}
.star-glow{position:absolute;inset:-12px;border-radius:50%;background:radial-gradient(circle,rgba(102,126,234,0.15),transparent 70%);animation:breathe 4s ease-in-out infinite;pointer-events:none}
.star-body{position:absolute;inset:0;border-radius:50%;background:radial-gradient(135deg,rgba(40,40,80,0.9),rgba(20,20,50,0.95));border:1.5px solid rgba(102,126,234,0.3);display:flex;flex-direction:column;align-items:center;justify-content:center;transition:border-color 0.3s,transform 0.2s;overflow:hidden}
.star:hover .star-body{border-color:rgba(102,126,234,0.7);transform:scale(1.08)}
.star.selected .star-body{border-color:rgba(102,126,234,0.9);box-shadow:0 0 20px rgba(102,126,234,0.3)}
.star-icon{font-size:18px;line-height:1;margin-bottom:1px;filter:drop-shadow(0 0 3px rgba(200,200,255,0.3))}
.star-name{font-size:8px;font-weight:600;color:var(--text-bright);text-align:center;line-height:1.1;max-width:60px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.star-badge{position:absolute;top:-4px;right:-4px;min-width:14px;height:14px;border-radius:7px;font-size:8px;font-weight:700;display:flex;align-items:center;justify-content:center;padding:0 3px;color:#fff;z-index:2}
.star-health{position:absolute;bottom:-2px;left:50%;transform:translateX(-50%);width:6px;height:6px;border-radius:50%;z-index:2}
@keyframes breathe{0%,100%{transform:scale(0.95);opacity:0.7}50%{transform:scale(1.05);opacity:1}}
.star:nth-child(2) .star-glow{animation-delay:-0.5s}
.star:nth-child(3) .star-glow{animation-delay:-1s}
.star:nth-child(4) .star-glow{animation-delay:-1.5s}
.star:nth-child(5) .star-glow{animation-delay:-2s}
.star:nth-child(6) .star-glow{animation-delay:-2.5s}
.star:nth-child(7) .star-glow{animation-delay:-3s}
.star:nth-child(8) .star-glow{animation-delay:-3.5s}

/* ─── Gate Nodes ─── */
.gate{position:absolute;width:var(--gate-size);height:var(--gate-size);transform:translate(-50%,-50%) rotate(45deg);cursor:pointer;z-index:8}
.gate-body{width:100%;height:100%;border-radius:3px;background:rgba(30,30,60,0.9);border:1px solid rgba(100,100,200,0.25);transition:all 0.3s;display:flex;align-items:center;justify-content:center}
.gate-label{transform:rotate(-45deg);font-size:7px;font-weight:700;color:var(--text-dim);pointer-events:none;line-height:1}
.gate:hover .gate-body{border-color:rgba(140,140,255,0.6);background:rgba(50,50,90,0.9);transform:scale(1.3)}
.gate.healthy .gate-body{border-color:rgba(16,185,129,0.5);box-shadow:0 0 4px rgba(16,185,129,0.2)}
.gate.degraded .gate-body{border-color:rgba(245,158,11,0.5);box-shadow:0 0 4px rgba(245,158,11,0.2)}
.gate.critical .gate-body{border-color:rgba(239,68,68,0.5);box-shadow:0 0 4px rgba(239,68,68,0.2);animation:gate-pulse 1.5s ease-in-out infinite}
.gate.fired .gate-body{box-shadow:0 0 12px rgba(102,126,234,0.6);border-color:rgba(102,126,234,0.8)}
@keyframes gate-pulse{0%,100%{opacity:1}50%{opacity:0.5}}

/* ─── Detail Panel ─── */
#panel{position:fixed;top:32px;right:0;bottom:24px;width:340px;background:var(--panel-bg);border-left:1px solid var(--panel-border);transform:translateX(100%);transition:transform 0.25s ease;z-index:50;overflow-y:auto;padding:14px;font-size:11px}
#panel.open{transform:translateX(0)}
#panel h2{font-size:14px;font-weight:700;color:var(--text-bright);margin-bottom:8px;display:flex;align-items:center;gap:8px}
#panel .close-btn{margin-left:auto;cursor:pointer;color:var(--text-dim);font-size:16px;background:none;border:none;padding:2px 6px;border-radius:4px}
#panel .close-btn:hover{background:rgba(255,255,255,0.1);color:var(--text-bright)}
.panel-section{margin-bottom:12px;padding:10px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:8px}
.panel-section h3{font-size:11px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px}
.panel-row{display:flex;justify-content:space-between;align-items:center;padding:3px 0}
.panel-row .label{color:var(--text-dim)}
.panel-row .value{font-weight:600;color:var(--text-bright)}
.panel-bar{height:4px;background:rgba(255,255,255,0.08);border-radius:2px;margin:4px 0;overflow:hidden}
.panel-bar-fill{height:100%;border-radius:2px;transition:width 0.4s ease}
.trace-list{max-height:200px;overflow-y:auto}
.trace-item{padding:4px 6px;margin:2px 0;background:rgba(255,255,255,0.02);border-radius:4px;border-left:2px solid transparent;font-size:10px}
.trace-item.pass{border-left-color:#10b981}
.trace-item.fail{border-left-color:#ef4444}
.trace-item .trace-time{color:var(--text-dim);font-size:9px}

/* ─── SVG Bridges ─── */
svg .bridge{stroke:rgba(100,100,200,0.12);stroke-width:1.5;fill:none;transition:stroke 0.5s}
svg .bridge:hover{stroke:rgba(100,100,200,0.35);stroke-width:2}
svg .bridge-glow{stroke:rgba(100,130,255,0.06);stroke-width:6;fill:none;filter:blur(3px)}

/* ─── Health Overlay ─── */
#health-overlay{position:fixed;top:32px;left:0;right:0;bottom:24px;pointer-events:none;z-index:5;opacity:0;transition:opacity 0.3s}
#health-overlay.visible{opacity:1}

/* ─── Tooltip ─── */
#tooltip{position:fixed;background:rgba(15,15,40,0.95);border:1px solid rgba(100,100,200,0.3);border-radius:6px;padding:6px 10px;font-size:10px;color:var(--text);z-index:200;pointer-events:none;opacity:0;transition:opacity 0.15s;max-width:200px;box-shadow:0 4px 12px rgba(0,0,0,0.4)}
#tooltip.show{opacity:1}
</style>
</head>
<body>

<!-- Top Bar -->
<div id="topbar">
  <span class="logo">ActionFlows</span>
  <div class="sep"></div>
  <span class="status-dot off" id="backend-dot"></span>
  <span id="backend-label">Backend</span>
  <div class="sep"></div>
  <span id="score-badge" class="score-badge" style="color:var(--text-dim)">--</span>
  <span class="meta">Health Score</span>
  <div class="sep"></div>
  <span class="meta" id="session-count">0 sessions</span>
  <div class="sep"></div>
  <span class="meta" id="violation-count">0 violations (24h)</span>
  <div class="right">
    <span class="meta" id="last-refresh">--</span>
    <kbd>R</kbd> refresh
    <kbd>H</kbd> overlay
    <kbd>Esc</kbd> close
  </div>
</div>

<!-- Aurora Background -->
<div id="aurora" class="healthy"></div>

<!-- Cosmos Container -->
<div id="cosmos">
  <canvas id="particles"></canvas>
  <svg id="bridges" xmlns="http://www.w3.org/2000/svg"></svg>
  <div id="star-container"></div>
  <div id="gate-container"></div>
</div>

<!-- Health Overlay -->
<div id="health-overlay"></div>

<!-- Detail Panel -->
<div id="panel">
  <h2><span id="panel-icon"></span><span id="panel-title">Details</span><button class="close-btn" onclick="closePanel()">&times;</button></h2>
  <div id="panel-content"></div>
</div>

<!-- Bottom Ticker -->
<div id="bottombar">
  <span id="drift-count">0 drift patterns</span>
  <div class="sep" style="width:1px;height:12px;background:var(--panel-border)"></div>
  <span id="ticker">Waiting for data...</span>
</div>

<!-- Tooltip -->
<div id="tooltip"></div>

<script>
// ════════════════════════════════════════════════════════════════
// Configuration
// ════════════════════════════════════════════════════════════════
const API_BASE = 'http://localhost:3001';
const POLL_INTERVAL = 10000;
let pollTimer = null;
let healthOverlayVisible = false;

// ════════════════════════════════════════════════════════════════
// Architecture Data
// ════════════════════════════════════════════════════════════════
const STARS = [
  { id: 'pm',          name: 'The War Table',          icon: '\u265A', purpose: 'Project management, roadmaps',      col: 3, row: 0 },
  { id: 'explore',     name: "Cartographer's Table",   icon: '\u2699', purpose: 'Research, investigation',           col: 1.5, row: 1 },
  { id: 'work',        name: 'The Hearth',             icon: '\uD83D\uDD25', purpose: 'Active development, sessions', col: 3, row: 1 },
  { id: 'review',      name: 'The Tribunal',           icon: '\u2696', purpose: 'Code reviews, audits, quality',     col: 4.5, row: 1 },
  { id: 'settings',    name: 'The Loom',               icon: '\u2699', purpose: 'Configuration, framework dev',      col: 1.5, row: 2 },
  { id: 'maintenance', name: 'The Observatory',        icon: '\uD83D\uDD2D', purpose: 'Bug fixes, refactoring, health', col: 3, row: 2 },
  { id: 'archive',     name: 'The Vault',              icon: '\uD83D\uDD12', purpose: 'Historical sessions, completed', col: 4.5, row: 2 },
  { id: 'intel',       name: 'The Spy Glass',          icon: '\uD83D\uDD0D', purpose: 'Code intelligence, dossiers',   col: 3, row: 3 },
  { id: 'story',       name: 'The Chronicle',          icon: '\uD83D\uDCD6', purpose: 'Narrative, Story of Us',         col: 1.5, row: 3.5 },
  { id: 'respect',     name: 'The Guardian',           icon: '\uD83D\uDEE1', purpose: 'Boundary compliance',            col: 4.5, row: 3.5 },
];

const BRIDGES = [
  { from: 'pm',       to: 'work',        label: 'Planning drives dev' },
  { from: 'explore',  to: 'work',        label: 'Research to implementation' },
  { from: 'work',     to: 'review',      label: 'Code flows to review' },
  { from: 'work',     to: 'maintenance', label: 'Bugs found during work' },
  { from: 'settings', to: 'maintenance', label: 'Config affects health' },
  { from: 'settings', to: 'work',        label: 'Config affects development' },
  { from: 'review',   to: 'archive',     label: 'Completed reviews archived' },
  { from: 'maintenance', to: 'intel',    label: 'Health feeds intelligence' },
  { from: 'intel',    to: 'respect',     label: 'Intelligence informs boundaries' },
  { from: 'story',    to: 'work',        label: 'Narrative guides creation' },
  { from: 'pm',       to: 'explore',     label: 'Planning triggers research' },
  { from: 'maintenance', to: 'archive',  label: 'Fixed issues archived' },
];

const GATES = [
  { id: 'gate-01', name: 'Request Reception',        num: '01', group: 'entry',    along: ['pm','work'],           t: 0.3 },
  { id: 'gate-02', name: 'Route to Context',          num: '02', group: 'entry',    along: ['explore','work'],      t: 0.5 },
  { id: 'gate-03', name: 'Find the Flow',             num: '03', group: 'compile',  along: ['work','review'],       t: 0.2 },
  { id: 'gate-04', name: 'Compile Chain',             num: '04', group: 'compile',  along: ['work','review'],       t: 0.35 },
  { id: 'gate-05', name: 'Present Chain',             num: '05', group: 'compile',  along: ['work','review'],       t: 0.5 },
  { id: 'gate-06', name: 'Step Boundary',             num: '06', group: 'exec',     along: ['work','maintenance'],  t: 0.35 },
  { id: 'gate-07', name: 'Triage Fix',                num: '07', group: 'exec',     along: ['work','maintenance'],  t: 0.65 },
  { id: 'gate-08', name: 'Format Output',             num: '08', group: 'harmony',  along: ['settings','maintenance'], t: 0.3 },
  { id: 'gate-09', name: 'Agent Output',              num: '09', group: 'exec',     along: ['review','archive'],    t: 0.3 },
  { id: 'gate-10', name: 'Learning Surface',          num: '10', group: 'learning', along: ['maintenance','intel'], t: 0.3 },
  { id: 'gate-11', name: 'Fresh Eye Discovery',       num: '11', group: 'learning', along: ['maintenance','intel'], t: 0.6 },
  { id: 'gate-12', name: 'Registry Update',           num: '12', group: 'registry', along: ['settings','work'],     t: 0.4 },
  { id: 'gate-13', name: 'Flow Composition',          num: '13', group: 'compile',  along: ['settings','maintenance'], t: 0.6 },
  { id: 'gate-14', name: 'Commit Gate',               num: '14', group: 'commit',   along: ['review','archive'],    t: 0.65 },
  { id: 'gate-15', name: 'Second Opinion',            num: '15', group: 'review',   along: ['work','review'],       t: 0.7 },
  { id: 'gate-16', name: 'Recompilation',             num: '16', group: 'exec',     along: ['pm','work'],           t: 0.6 },
  { id: 'gate-17', name: 'Autonomous Follow-Through', num: '17', group: 'exec',     along: ['pm','explore'],        t: 0.5 },
  { id: 'gate-18', name: 'Chain Continuation',        num: '18', group: 'exec',     along: ['explore','work'],      t: 0.8 },
];

const GATE_GROUPS = {
  entry:    { color: '#60a5fa', label: 'Entry' },
  compile:  { color: '#a78bfa', label: 'Compile' },
  exec:     { color: '#f59e0b', label: 'Execution' },
  harmony:  { color: '#10b981', label: 'Harmony' },
  learning: { color: '#ec4899', label: 'Learning' },
  registry: { color: '#06b6d4', label: 'Registry' },
  review:   { color: '#8b5cf6', label: 'Review' },
  commit:   { color: '#14b8a6', label: 'Commit' },
};

// ════════════════════════════════════════════════════════════════
// State
// ════════════════════════════════════════════════════════════════
let state = {
  connected: false,
  health: null,
  sessions: [],
  selectedStar: null,
  selectedGate: null,
  panelOpen: false,
  tickerMessages: [],
  gateFireTimes: {},
};

// ════════════════════════════════════════════════════════════════
// Layout Computation
// ════════════════════════════════════════════════════════════════
function getViewport() {
  const t = 32, b = 24;
  return { x: 0, y: t, w: window.innerWidth, h: window.innerHeight - t - b };
}

function starPos(star) {
  const vp = getViewport();
  const cols = 6, rows = 4.5;
  const padX = 80, padY = 60;
  const usableW = vp.w - (state.panelOpen ? 340 : 0) - padX * 2;
  const usableH = vp.h - padY * 2;
  return {
    x: padX + (star.col / cols) * usableW,
    y: vp.y + padY + (star.row / rows) * usableH,
  };
}

function findBridge(fromId, toId) {
  return BRIDGES.find(b => (b.from === fromId && b.to === toId) || (b.from === toId && b.to === fromId));
}

function gatePos(gate) {
  const [aId, bId] = gate.along;
  const a = STARS.find(s => s.id === aId);
  const b = STARS.find(s => s.id === bId);
  if (!a || !b) return { x: 0, y: 0 };
  const pa = starPos(a), pb = starPos(b);
  const t = gate.t;
  // Slight curve offset to avoid overlapping the bridge line
  const mx = pa.x + (pb.x - pa.x) * t;
  const my = pa.y + (pb.y - pa.y) * t;
  const dx = pb.x - pa.x, dy = pb.y - pa.y;
  const len = Math.sqrt(dx * dx + dy * dy) || 1;
  const nx = -dy / len, ny = dx / len;
  const offset = 14;
  return { x: mx + nx * offset, y: my + ny * offset };
}

// ════════════════════════════════════════════════════════════════
// Rendering — Stars
// ════════════════════════════════════════════════════════════════
function renderStars() {
  const container = document.getElementById('star-container');
  container.innerHTML = '';
  STARS.forEach((star, i) => {
    const pos = starPos(star);
    const el = document.createElement('div');
    el.className = 'star';
    el.id = `star-${star.id}`;
    el.style.left = pos.x + 'px';
    el.style.top = pos.y + 'px';
    el.style.animationDelay = `${-i * 0.6}s`;

    const sessionCount = state.sessions.filter(s => s.context === star.id || s.workbench === star.id).length;
    const healthClass = getStarHealthClass(star.id);

    el.innerHTML = `
      <div class="star-glow" style="animation-delay:${-i * 0.6}s"></div>
      <div class="star-body">
        <span class="star-icon">${star.icon}</span>
        <span class="star-name">${star.name}</span>
      </div>
      ${sessionCount > 0 ? `<span class="star-badge" style="background:#667eea">${sessionCount}</span>` : ''}
      <span class="star-health status-dot ${healthClass}" style="position:absolute;bottom:-2px;left:50%;transform:translateX(-50%)"></span>
    `;

    el.addEventListener('click', () => selectStar(star));
    el.addEventListener('mouseenter', (e) => showTooltip(e, `${star.name}\n${star.purpose}`));
    el.addEventListener('mouseleave', hideTooltip);
    container.appendChild(el);
  });
}

function getStarHealthClass(starId) {
  if (!state.health || !state.health.byGate) return 'off';
  // A star's health = average of gates that touch it
  const touchingGates = GATES.filter(g => g.along.includes(starId));
  if (touchingGates.length === 0) return 'ok';
  let total = 0, count = 0;
  touchingGates.forEach(g => {
    const gh = state.health.byGate[g.id];
    if (gh) { total += gh.score; count++; }
  });
  if (count === 0) return 'ok';
  const avg = total / count;
  if (avg >= 90) return 'ok';
  if (avg >= 70) return 'warn';
  return 'err';
}

// ════════════════════════════════════════════════════════════════
// Rendering — Gates
// ════════════════════════════════════════════════════════════════
function renderGates() {
  const container = document.getElementById('gate-container');
  container.innerHTML = '';
  GATES.forEach(gate => {
    const pos = gatePos(gate);
    const el = document.createElement('div');
    const healthClass = getGateHealthClass(gate.id);
    const firedRecently = (Date.now() - (state.gateFireTimes[gate.id] || 0)) < 5000;
    el.className = `gate ${healthClass}${firedRecently ? ' fired' : ''}`;
    el.id = `gate-${gate.id}`;
    el.style.left = pos.x + 'px';
    el.style.top = pos.y + 'px';

    const groupColor = GATE_GROUPS[gate.group]?.color || '#667eea';
    el.innerHTML = `
      <div class="gate-body" style="border-color:${groupColor}40">
        <span class="gate-label">${gate.num}</span>
      </div>
    `;

    el.addEventListener('click', () => selectGate(gate));
    el.addEventListener('mouseenter', (e) => showTooltip(e, `Gate ${gate.num}: ${gate.name}\n${GATE_GROUPS[gate.group]?.label || ''}`));
    el.addEventListener('mouseleave', hideTooltip);
    container.appendChild(el);
  });
}

function getGateHealthClass(gateId) {
  if (!state.health || !state.health.byGate) return '';
  const gh = state.health.byGate[gateId];
  if (!gh) return '';
  if (gh.score >= 90) return 'healthy';
  if (gh.score >= 70) return 'degraded';
  return 'critical';
}

// ════════════════════════════════════════════════════════════════
// Rendering — SVG Bridges
// ════════════════════════════════════════════════════════════════
function renderBridges() {
  const svg = document.getElementById('bridges');
  const vp = getViewport();
  svg.setAttribute('viewBox', `0 ${vp.y} ${vp.w} ${vp.h}`);
  svg.setAttribute('width', vp.w);
  svg.setAttribute('height', vp.h);
  svg.style.top = '0px';

  let html = '';
  // Defs for arrow markers and glow
  html += `<defs>
    <filter id="bridge-glow"><feGaussianBlur stdDeviation="3" result="blur"/><feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
    <marker id="arrow" viewBox="0 0 6 6" refX="3" refY="3" markerWidth="4" markerHeight="4" orient="auto-start-reverse"><path d="M0,0 L6,3 L0,6 Z" fill="rgba(100,100,200,0.25)"/></marker>
  </defs>`;

  BRIDGES.forEach(bridge => {
    const fromStar = STARS.find(s => s.id === bridge.from);
    const toStar = STARS.find(s => s.id === bridge.to);
    if (!fromStar || !toStar) return;
    const p1 = starPos(fromStar), p2 = starPos(toStar);
    // Quadratic curve with slight bend
    const mx = (p1.x + p2.x) / 2;
    const my = (p1.y + p2.y) / 2;
    const dx = p2.x - p1.x, dy = p2.y - p1.y;
    const len = Math.sqrt(dx * dx + dy * dy) || 1;
    const nx = -dy / len, ny = dx / len;
    const bend = 20;
    const cx = mx + nx * bend, cy = my + ny * bend;
    const d = `M${p1.x},${p1.y} Q${cx},${cy} ${p2.x},${p2.y}`;

    // Glow layer
    html += `<path class="bridge-glow" d="${d}" data-from="${bridge.from}" data-to="${bridge.to}"/>`;
    // Main line
    html += `<path class="bridge" d="${d}" marker-end="url(#arrow)" data-from="${bridge.from}" data-to="${bridge.to}" data-label="${bridge.label}"/>`;
  });

  svg.innerHTML = html;

  // Bridge hover events
  svg.querySelectorAll('.bridge').forEach(path => {
    path.addEventListener('mouseenter', (e) => {
      const label = path.getAttribute('data-label');
      const from = path.getAttribute('data-from');
      const to = path.getAttribute('data-to');
      showTooltip(e, `${from} \u2192 ${to}\n${label}`);
    });
    path.addEventListener('mouseleave', hideTooltip);
  });
}

// ════════════════════════════════════════════════════════════════
// Particle Canvas — Sparks flowing along bridges
// ════════════════════════════════════════════════════════════════
const particles = [];
const MAX_PARTICLES = 80;

function initParticleCanvas() {
  const canvas = document.getElementById('particles');
  const vp = getViewport();
  canvas.width = vp.w;
  canvas.height = vp.h;
  canvas.style.top = vp.y + 'px';
}

function spawnParticles() {
  // Maintain a pool of particles along bridges
  if (particles.length >= MAX_PARTICLES) return;
  const bridge = BRIDGES[Math.floor(Math.random() * BRIDGES.length)];
  const fromStar = STARS.find(s => s.id === bridge.from);
  const toStar = STARS.find(s => s.id === bridge.to);
  if (!fromStar || !toStar) return;

  const p1 = starPos(fromStar), p2 = starPos(toStar);
  const vp = getViewport();

  particles.push({
    x: p1.x, y: p1.y - vp.y,
    tx: p2.x, ty: p2.y - vp.y,
    t: 0,
    speed: 0.003 + Math.random() * 0.005,
    size: 1 + Math.random() * 1.5,
    alpha: 0.3 + Math.random() * 0.4,
    hue: 220 + Math.random() * 40,
  });
}

function updateParticles() {
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    p.t += p.speed;
    if (p.t >= 1) {
      particles.splice(i, 1);
      continue;
    }
    // Quadratic bezier along bridge
    const mx = (p.x + p.tx) / 2, my = (p.y + p.ty) / 2;
    const dx = p.tx - p.x, dy = p.ty - p.y;
    const len = Math.sqrt(dx * dx + dy * dy) || 1;
    const nx = -dy / len, ny = dx / len;
    const bend = 20;
    const cx = mx + nx * bend, cy = my + ny * bend;

    const t = p.t;
    const omt = 1 - t;
    p.cx = omt * omt * p.x + 2 * omt * t * cx + t * t * p.tx;
    p.cy = omt * omt * p.y + 2 * omt * t * cy + t * t * p.ty;
  }
}

function drawParticles() {
  const canvas = document.getElementById('particles');
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  particles.forEach(p => {
    if (p.cx === undefined) return;
    ctx.beginPath();
    ctx.arc(p.cx, p.cy, p.size, 0, Math.PI * 2);
    const fade = p.t < 0.1 ? p.t / 0.1 : p.t > 0.9 ? (1 - p.t) / 0.1 : 1;
    ctx.fillStyle = `hsla(${p.hue}, 70%, 75%, ${p.alpha * fade})`;
    ctx.fill();
  });
}

let animFrame;
function animationLoop() {
  spawnParticles();
  updateParticles();
  drawParticles();
  animFrame = requestAnimationFrame(animationLoop);
}

// Pause animation when tab is hidden (battery/CPU savings)
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    cancelAnimationFrame(animFrame);
  } else {
    animationLoop();
  }
});

// ════════════════════════════════════════════════════════════════
// Tooltip
// ════════════════════════════════════════════════════════════════
function showTooltip(e, text) {
  const tip = document.getElementById('tooltip');
  tip.textContent = text;
  tip.className = 'show';
  const rect = tip.getBoundingClientRect();
  let x = e.clientX + 12;
  let y = e.clientY - 8;
  if (x + 200 > window.innerWidth) x = e.clientX - 210;
  if (y + 60 > window.innerHeight) y = e.clientY - 50;
  tip.style.left = x + 'px';
  tip.style.top = y + 'px';
}

function hideTooltip() {
  document.getElementById('tooltip').className = '';
}

// ════════════════════════════════════════════════════════════════
// Panel — Star Detail
// ════════════════════════════════════════════════════════════════
function selectStar(star) {
  // Deselect previous
  document.querySelectorAll('.star.selected').forEach(el => el.classList.remove('selected'));
  state.selectedStar = star;
  state.selectedGate = null;

  const el = document.getElementById(`star-${star.id}`);
  if (el) el.classList.add('selected');

  // Highlight connected bridges
  highlightConnections(star.id);

  const sessionCount = state.sessions.filter(s => s.context === star.id || s.workbench === star.id).length;
  const touchingGates = GATES.filter(g => g.along.includes(star.id));
  const connectedStars = new Set();
  BRIDGES.forEach(b => {
    if (b.from === star.id) connectedStars.add(b.to);
    if (b.to === star.id) connectedStars.add(b.from);
  });

  let gateRows = '';
  touchingGates.forEach(g => {
    const gh = state.health?.byGate?.[g.id];
    const score = gh ? gh.score : '--';
    const cls = gh ? (gh.score >= 90 ? 'ok' : gh.score >= 70 ? 'warn' : 'err') : 'off';
    gateRows += `<div class="panel-row"><span class="label">Gate ${g.num}: ${g.name}</span><span class="value"><span class="status-dot ${cls}"></span>${score}</span></div>`;
  });

  document.getElementById('panel-icon').textContent = star.icon;
  document.getElementById('panel-title').textContent = star.name;
  document.getElementById('panel-content').innerHTML = `
    <div class="panel-section">
      <h3>Overview</h3>
      <div class="panel-row"><span class="label">ID</span><span class="value">${star.id}</span></div>
      <div class="panel-row"><span class="label">Purpose</span><span class="value" style="font-weight:400;font-size:10px">${star.purpose}</span></div>
      <div class="panel-row"><span class="label">Active Sessions</span><span class="value">${sessionCount}</span></div>
      <div class="panel-row"><span class="label">Connected To</span><span class="value" style="font-size:10px">${[...connectedStars].join(', ') || 'None'}</span></div>
    </div>
    <div class="panel-section">
      <h3>Gate Health (${touchingGates.length} gates)</h3>
      ${gateRows || '<div style="color:var(--text-dim)">No gates touch this star</div>'}
    </div>
  `;

  openPanel();
}

function selectGate(gate) {
  state.selectedGate = gate;
  state.selectedStar = null;
  document.querySelectorAll('.star.selected').forEach(el => el.classList.remove('selected'));
  clearHighlights();

  const gh = state.health?.byGate?.[gate.id];
  const score = gh ? gh.score : '--';
  const passCount = gh?.passCount ?? 0;
  const failCount = gh?.failCount ?? 0;
  const total = passCount + failCount;
  const trend = gh?.trend ?? 'stable';
  const trendIcon = trend === 'improving' ? '\u2197' : trend === 'declining' ? '\u2198' : '\u2192';
  const cls = gh ? (gh.score >= 90 ? 'ok' : gh.score >= 70 ? 'warn' : 'err') : 'off';
  const barColor = gh ? (gh.score >= 90 ? '#10b981' : gh.score >= 70 ? '#f59e0b' : '#ef4444') : '#555';
  const groupInfo = GATE_GROUPS[gate.group] || {};

  // Recent traces
  let tracesHtml = '<div style="color:var(--text-dim)">No recent traces</div>';
  if (gh?.recentTraces && gh.recentTraces.length > 0) {
    tracesHtml = '<div class="trace-list">';
    gh.recentTraces.slice(0, 10).forEach(tr => {
      const passed = tr.validationResult?.passed !== false;
      tracesHtml += `<div class="trace-item ${passed ? 'pass' : 'fail'}">
        <div>${passed ? '\u2713 Pass' : '\u2717 Fail'}: ${esc(tr.chainId || tr.gateId || 'unknown')}</div>
        <div class="trace-time">${new Date(tr.timestamp).toLocaleTimeString()}</div>
      </div>`;
    });
    tracesHtml += '</div>';
  }

  // Violations
  let violationsHtml = '';
  if (gh?.violations && gh.violations.length > 0) {
    violationsHtml = '<div class="panel-section"><h3>Violations</h3>';
    gh.violations.slice(0, 5).forEach(v => {
      violationsHtml += `<div class="trace-item fail"><div>${esc(v.message || v.type || 'Unknown violation')}</div><div class="trace-time">${v.timestamp ? new Date(v.timestamp).toLocaleTimeString() : ''}</div></div>`;
    });
    violationsHtml += '</div>';
  }

  document.getElementById('panel-icon').textContent = '\u25C6';
  document.getElementById('panel-title').textContent = `Gate ${gate.num}: ${gate.name}`;
  document.getElementById('panel-content').innerHTML = `
    <div class="panel-section">
      <h3>Health</h3>
      <div class="panel-row"><span class="label">Score</span><span class="value"><span class="status-dot ${cls}"></span>${score}</span></div>
      <div class="panel-bar"><div class="panel-bar-fill" style="width:${score === '--' ? 0 : score}%;background:${barColor}"></div></div>
      <div class="panel-row"><span class="label">Trend</span><span class="value">${trendIcon} ${trend}</span></div>
      <div class="panel-row"><span class="label">Group</span><span class="value" style="color:${groupInfo.color || '#aaa'}">${groupInfo.label || gate.group}</span></div>
    </div>
    <div class="panel-section">
      <h3>Statistics</h3>
      <div class="panel-row"><span class="label">Pass</span><span class="value" style="color:#10b981">${passCount}</span></div>
      <div class="panel-row"><span class="label">Fail</span><span class="value" style="color:#ef4444">${failCount}</span></div>
      <div class="panel-row"><span class="label">Total</span><span class="value">${total}</span></div>
    </div>
    <div class="panel-section">
      <h3>Recent Traces</h3>
      ${tracesHtml}
    </div>
    ${violationsHtml}
    <div class="panel-section">
      <h3>Connections</h3>
      <div class="panel-row"><span class="label">Between</span><span class="value" style="font-size:10px">${gate.along.join(' \u2194 ')}</span></div>
    </div>
  `;

  openPanel();
}

// ════════════════════════════════════════════════════════════════
// Panel Controls
// ════════════════════════════════════════════════════════════════
function openPanel() {
  state.panelOpen = true;
  document.getElementById('panel').classList.add('open');
  // Re-layout after panel opens
  setTimeout(fullRender, 30);
}

function closePanel() {
  state.panelOpen = false;
  state.selectedStar = null;
  state.selectedGate = null;
  document.getElementById('panel').classList.remove('open');
  document.querySelectorAll('.star.selected').forEach(el => el.classList.remove('selected'));
  clearHighlights();
  setTimeout(fullRender, 30);
}

function highlightConnections(starId) {
  const svg = document.getElementById('bridges');
  svg.querySelectorAll('.bridge').forEach(path => {
    const from = path.getAttribute('data-from');
    const to = path.getAttribute('data-to');
    if (from === starId || to === starId) {
      path.style.stroke = 'rgba(102,126,234,0.5)';
      path.style.strokeWidth = '2.5';
    } else {
      path.style.stroke = 'rgba(100,100,200,0.06)';
      path.style.strokeWidth = '1';
    }
  });
  svg.querySelectorAll('.bridge-glow').forEach(path => {
    const from = path.getAttribute('data-from');
    const to = path.getAttribute('data-to');
    if (from === starId || to === starId) {
      path.style.stroke = 'rgba(100,130,255,0.15)';
    } else {
      path.style.stroke = 'rgba(100,130,255,0.02)';
    }
  });
}

function clearHighlights() {
  const svg = document.getElementById('bridges');
  svg.querySelectorAll('.bridge').forEach(path => {
    path.style.stroke = '';
    path.style.strokeWidth = '';
  });
  svg.querySelectorAll('.bridge-glow').forEach(path => {
    path.style.stroke = '';
  });
}

// ════════════════════════════════════════════════════════════════
// Health Overlay
// ════════════════════════════════════════════════════════════════
function toggleHealthOverlay() {
  healthOverlayVisible = !healthOverlayVisible;
  const overlay = document.getElementById('health-overlay');
  overlay.classList.toggle('visible', healthOverlayVisible);

  if (healthOverlayVisible && state.health) {
    renderHealthOverlay();
  }
}

function renderHealthOverlay() {
  const overlay = document.getElementById('health-overlay');
  const vp = getViewport();

  let html = '<svg style="width:100%;height:100%" viewBox="0 ' + vp.y + ' ' + vp.w + ' ' + vp.h + '">';

  GATES.forEach(gate => {
    const pos = gatePos(gate);
    const gh = state.health?.byGate?.[gate.id];
    const score = gh ? gh.score : 100;
    const r = 20 + (100 - score) * 0.3;
    const color = score >= 90 ? '16,185,129' : score >= 70 ? '245,158,11' : '239,68,68';
    const opacity = score >= 90 ? 0.05 : score >= 70 ? 0.12 : 0.2;

    html += `<circle cx="${pos.x}" cy="${pos.y}" r="${r}" fill="rgba(${color},${opacity})" stroke="rgba(${color},0.2)" stroke-width="0.5"/>`;
    html += `<text x="${pos.x}" y="${pos.y + 3}" text-anchor="middle" fill="rgba(${color},0.6)" font-size="8" font-weight="700">${score}</text>`;
  });

  html += '</svg>';
  overlay.innerHTML = html;
}

// ════════════════════════════════════════════════════════════════
// Ambient Health — Background Color
// ════════════════════════════════════════════════════════════════
function updateAmbientHealth() {
  const overall = state.health?.overall ?? 100;
  const aurora = document.getElementById('aurora');
  const body = document.body;

  body.classList.remove('degraded', 'critical');
  aurora.classList.remove('healthy', 'degraded', 'critical');

  if (overall >= 90) {
    aurora.classList.add('healthy');
  } else if (overall >= 70) {
    body.classList.add('degraded');
    aurora.classList.add('degraded');
  } else {
    body.classList.add('critical');
    aurora.classList.add('critical');
  }
}

// ════════════════════════════════════════════════════════════════
// Top Bar Updates
// ════════════════════════════════════════════════════════════════
function updateTopBar() {
  const dot = document.getElementById('backend-dot');
  const label = document.getElementById('backend-label');
  dot.className = `status-dot ${state.connected ? 'ok' : 'off'}`;
  label.textContent = state.connected ? 'Connected' : 'Disconnected';

  const overall = state.health?.overall;
  const badge = document.getElementById('score-badge');
  if (overall !== undefined && overall !== null) {
    badge.textContent = overall;
    badge.style.color = overall >= 90 ? '#10b981' : overall >= 70 ? '#f59e0b' : '#ef4444';
  } else {
    badge.textContent = '--';
    badge.style.color = 'var(--text-dim)';
  }

  document.getElementById('session-count').textContent = `${state.sessions.length} session${state.sessions.length !== 1 ? 's' : ''}`;
  document.getElementById('violation-count').textContent = `${state.health?.violations24h ?? 0} violations (24h)`;
  document.getElementById('last-refresh').textContent = new Date().toLocaleTimeString();
}

// ════════════════════════════════════════════════════════════════
// Bottom Bar Updates
// ════════════════════════════════════════════════════════════════
function updateBottomBar() {
  const driftCount = state.health?.driftPatterns?.length ?? 0;
  document.getElementById('drift-count').textContent = `${driftCount} drift pattern${driftCount !== 1 ? 's' : ''}`;

  const recs = state.health?.recommendations || state.health?.healingRecommendations || [];
  if (recs.length > 0) {
    const msgs = recs.map(r => typeof r === 'string' ? r : (r.reason || r.pattern || r.suggestedFlow || JSON.stringify(r)));
    document.getElementById('ticker').textContent = msgs.join('  \u2022  ');
  } else if (state.connected) {
    document.getElementById('ticker').textContent = 'System nominal — no drift patterns detected';
  } else {
    document.getElementById('ticker').textContent = 'Waiting for backend connection...';
  }
}

// ════════════════════════════════════════════════════════════════
// Data Fetching
// ════════════════════════════════════════════════════════════════
async function fetchData() {
  try {
    // Fetch health and sessions in parallel
    const [healthRes, sessionsRes] = await Promise.allSettled([
      fetch(`${API_BASE}/api/harmony/health`),
      fetch(`${API_BASE}/api/sessions`),
    ]);

    state.connected = true;

    if (healthRes.status === 'fulfilled' && healthRes.value.ok) {
      state.health = await healthRes.value.json();
    }

    if (sessionsRes.status === 'fulfilled' && sessionsRes.value.ok) {
      const data = await sessionsRes.value.json();
      state.sessions = data.sessions || data || [];
    }

    // Try fetching gate details for any open gate panel
    if (state.selectedGate && state.health) {
      try {
        const gateRes = await fetch(`${API_BASE}/api/harmony/health/gate/${state.selectedGate.id}`);
        if (gateRes.ok) {
          const gateData = await gateRes.json();
          // Merge detailed data
          if (!state.health.byGate) state.health.byGate = {};
          state.health.byGate[state.selectedGate.id] = {
            ...state.health.byGate[state.selectedGate.id],
            ...gateData,
          };
        }
      } catch (_) { /* non-critical */ }
    }
  } catch (err) {
    state.connected = false;
  }

  updateUI();
}

// HTML-escape helper for XSS prevention
function esc(str) {
  if (!str) return '';
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

// ════════════════════════════════════════════════════════════════
// Full Render
// ════════════════════════════════════════════════════════════════
function fullRender() {
  renderBridges();
  renderStars();
  renderGates();
  initParticleCanvas();
}

function updateUI() {
  updateTopBar();
  updateBottomBar();
  updateAmbientHealth();
  renderStars();
  renderGates();
  if (healthOverlayVisible) renderHealthOverlay();

  // Re-render panel if something is selected AND panel is open
  if (state.panelOpen && state.selectedStar) selectStar(state.selectedStar);
  if (state.panelOpen && state.selectedGate) selectGate(state.selectedGate);
}

// ════════════════════════════════════════════════════════════════
// WebSocket (optional real-time events)
// ════════════════════════════════════════════════════════════════
let ws = null;
let wsReconnectAttempts = 0;
const MAX_WS_RECONNECT = 10;

function connectWebSocket() {
  try {
    ws = new WebSocket(`ws://localhost:3001`);
    ws.onopen = () => { wsReconnectAttempts = 0; };
    ws.onmessage = (event) => {
      try {
        const msg = JSON.parse(event.data);
        handleWSEvent(msg);
      } catch (_) {}
    };
    ws.onclose = () => {
      ws = null;
      if (wsReconnectAttempts < MAX_WS_RECONNECT) {
        const delay = Math.min(30000, 5000 * Math.pow(1.5, wsReconnectAttempts));
        setTimeout(connectWebSocket, delay);
        wsReconnectAttempts++;
      }
    };
    ws.onerror = () => {
      ws = null;
    };
  } catch (_) {
    if (wsReconnectAttempts < MAX_WS_RECONNECT) {
      const delay = Math.min(30000, 5000 * Math.pow(1.5, wsReconnectAttempts));
      setTimeout(connectWebSocket, delay);
      wsReconnectAttempts++;
    }
  }
}

function handleWSEvent(msg) {
  const type = msg.type || msg.event;
  if (!type) return;

  // Track gate fires for visual pulse
  if (type.startsWith('gate:') || type.includes('gate')) {
    const gateId = msg.gateId || msg.data?.gateId;
    if (gateId) {
      state.gateFireTimes[gateId] = Date.now();
      const el = document.getElementById(`gate-${gateId}`);
      if (el) {
        el.classList.add('fired');
        setTimeout(() => el.classList.remove('fired'), 3000);
      }
    }
  }

  // Track session events
  if (type.includes('session')) {
    fetchData(); // Refresh data on session events
  }

  // Health updates
  if (type.includes('health') && msg.data) {
    state.health = msg.data;
    updateUI();
  }

  // Add to ticker
  const tickerMsg = msg.message || `${type}: ${msg.gateId || msg.sessionId || ''}`;
  addTickerMessage(tickerMsg);
}

function addTickerMessage(msg) {
  state.tickerMessages.unshift({ text: msg, time: Date.now() });
  if (state.tickerMessages.length > 20) state.tickerMessages.pop();
  const ticker = document.getElementById('ticker');
  ticker.textContent = state.tickerMessages.map(m => m.text).join('  \u2022  ');
}

// ════════════════════════════════════════════════════════════════
// Keyboard Shortcuts
// ════════════════════════════════════════════════════════════════
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closePanel();
  } else if (e.key === 'r' || e.key === 'R') {
    if (document.activeElement === document.body) {
      e.preventDefault();
      fetchData();
    }
  } else if (e.key === 'h' || e.key === 'H') {
    if (document.activeElement === document.body) {
      e.preventDefault();
      toggleHealthOverlay();
    }
  }
});

// ════════════════════════════════════════════════════════════════
// Resize Handler
// ════════════════════════════════════════════════════════════════
let resizeTimer;
window.addEventListener('resize', () => {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => {
    fullRender();
  }, 100);
});

// ════════════════════════════════════════════════════════════════
// Initialize
// ════════════════════════════════════════════════════════════════
function init() {
  fullRender();
  animationLoop();
  fetchData();
  connectWebSocket();
  pollTimer = setInterval(fetchData, POLL_INTERVAL);
}

// Cleanup on unload (prevent memory leaks)
window.addEventListener('beforeunload', () => {
  cancelAnimationFrame(animFrame);
  clearInterval(pollTimer);
  if (ws) ws.close();
});

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
